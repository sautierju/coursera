---
title: "Coursera Reproducible Research Week4"
author: "JS"
date: "October 13, 2016"
output: pdf_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='figures/',warning=FALSE, message=FALSE,cache=TRUE)
```
# Data Processing

Loading Packages and StormData File
```{r }
library(dplyr)
library(ggplot2)
library(reshape2)
library(gridExtra)

### Read CSV File already unziped
  data <- read.csv(file="repdata-data-StormData.csv",sep=",",header = TRUE)
```

Analysing the structure of the Data
```{r }
  #Show Type of DataSet
    str(data)
  #Show Label
    names(data)
  #Show Sample
    head(data)
```

## Q1 Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

The sum of Fatalities and Injuries are calculate within each Type of Event:
```{r }

    #Most harmful with respect to population health -> INJURIES
      dataQ1<-data[,c("STATE__","EVTYPE","FATALITIES","INJURIES")]
    
    #Sum of Injuries/Fatalities by Event Type
      SumOfFatalities <- dataQ1 %>% group_by(EVTYPE) %>% summarise(Fatalities = sum(FATALITIES))
      SumOfInjuries   <- dataQ1 %>% group_by(EVTYPE) %>% summarise(Injuries = sum(INJURIES))

      Agg_Harmful <- full_join(SumOfInjuries,SumOfFatalities,by=c("EVTYPE"))
      Agg_Harmful <- Agg_Harmful[rev(order(Agg_Harmful$Fatalities)),]
    
      Agg_Harmful_TopFat <- Agg_Harmful[1:10,] 
      Agg_Harmful_TopFat <- melt(Agg_Harmful_TopFat,Id.vars="EVTYPE")
   
    #Plot of Results 
    plotQ1 <- ggplot(Agg_Harmful_TopFat,aes(x=reorder(EVTYPE,-value),y=value,fill=factor(variable)))+
              geom_bar(stat="identity",position="dodge")+
              facet_grid(variable ~ .,scales="free")+
              scale_fill_discrete(name="Type of Offense")+xlab("Type Of Event")+ylab("Sum of Offense")
    
```

## Q2 Across the United States, which types of events have the greatest economic consequences?
    As defined within the National Weather Service Instruction, Number are rounded to three significant digits, 
    followed by an alphabetical character signifying the magnitude of the number
    
    -> Then alphabetical char need to be replaced by numeric values
    
```{r }
 #Set list of unique char within Property Damage
    
    unique(data$PROPDMGEXP)

    #Replace each Char by a num value : 
      data$PROPEXP[data$PROPDMGEXP == "0"] <- 1
      data$PROPEXP[data$PROPDMGEXP == ""]  <- 1
      data$PROPEXP[data$PROPDMGEXP == "h"] <- 100
      data$PROPEXP[data$PROPDMGEXP == "H"] <- 100
      data$PROPEXP[data$PROPDMGEXP == "K"] <- 1000
      data$PROPEXP[data$PROPDMGEXP == "M"] <- 1e+06
      data$PROPEXP[data$PROPDMGEXP == "m"] <- 1e+06
      data$PROPEXP[data$PROPDMGEXP == "B"] <- 1e+09
      data$PROPEXP[data$PROPDMGEXP == "1"] <- 10
      data$PROPEXP[data$PROPDMGEXP == "2"] <- 100
      data$PROPEXP[data$PROPDMGEXP == "3"] <- 1000
      data$PROPEXP[data$PROPDMGEXP == "4"] <- 10000
      data$PROPEXP[data$PROPDMGEXP == "5"] <- 1e+05
      data$PROPEXP[data$PROPDMGEXP == "6"] <- 1e+06
      data$PROPEXP[data$PROPDMGEXP == "7"] <- 1e+07
      data$PROPEXP[data$PROPDMGEXP == "8"] <- 1e+08
      
        #Tricky char are replaced by a 0:
        data$PROPEXP[data$PROPDMGEXP == "+"] <- 0
        data$PROPEXP[data$PROPDMGEXP == "-"] <- 0
        data$PROPEXP[data$PROPDMGEXP == "?"] <- 0

```
  Repeat the operation with Crop Dmg:
```{r }

      unique(data$CROPDMGEXP)
      
    #Replace each Char by a num value : 

      data$CROPEXP[data$CROPDMGEXP == "0"] <- 1
      data$CROPEXP[data$CROPDMGEXP == "2"] <- 100
      data$CROPEXP[data$CROPDMGEXP == "M"] <- 1e+06
      data$CROPEXP[data$CROPDMGEXP == "m"] <- 1e+06
      data$CROPEXP[data$CROPDMGEXP == "K"] <- 1000
      data$CROPEXP[data$CROPDMGEXP == "k"] <- 1000
      data$CROPEXP[data$CROPDMGEXP == "B"] <- 1e+09
    
    #Tricky char are replaced by a 0:
      data$CROPEXP[data$CROPDMGEXP == "?"] <- 0
```
Now the Global Damages within the US can be calculated:
```{r }
      #Calculate the Product of Dmg * Exponent
      data$PROPDMG_Value <- data$PROPDMG * data$PROPEXP
      data$CROPDMG_Value <- data$CROPDMG * data$CROPEXP

      #Data Subset Selection
      dataQ2<-data[,c("STATE__","EVTYPE","PROPDMG_Value","CROPDMG_Value")]
      
      #Sum of Damage by Event Type
      SumOfProp <- dataQ2 %>% group_by(EVTYPE) %>% summarise(PropDmg = sum(PROPDMG_Value,na.rm=TRUE))
      SumOfCrop <- dataQ2 %>% group_by(EVTYPE) %>% summarise(CropDmg = sum(CROPDMG_Value,na.rm=TRUE))
      
      Agg_Dmg <- full_join(SumOfProp,SumOfCrop,by=c("EVTYPE"))
      Agg_Dmg <- Agg_Dmg[-which(Agg_Dmg$PropDmg == "0"),]
      Agg_Dmg <- Agg_Dmg[-which(Agg_Dmg$CropDmg == "0"),]
      Agg_Dmg$Total <- Agg_Dmg$PropDmg + Agg_Dmg$CropDmg
      
      #Top 10 Prop
        Top10_Prop <-  SumOfProp[rev(order(SumOfProp$PropDmg)),]
        Top10_Prop <-  Top10_Prop[1:10,] 
        
      #Top 10 Crop
        Top10_Crop <-  SumOfCrop[rev(order(SumOfCrop$CropDmg)),]
        Top10_Crop <-  Top10_Crop[1:10,] 
      
      #Top 10 Agg
        Top10_Agg <-  Agg_Dmg[rev(order(Agg_Dmg$Total)),]
        Top10_Agg <-  Top10_Agg[1:10,] 
        
        
      #Plot of each Top10 Damages
        
      PlotProp <-  ggplot(Top10_Prop,aes(x=reorder(EVTYPE,-PropDmg),y=PropDmg,fill=PropDmg))+
                    geom_bar(stat="identity",position="dodge")+
                    xlab("Type Of Event")+ylab("Sum of Damages")+ggtitle("Top 10 Property Damage")
      
      PlotCrop <-  ggplot(Top10_Crop,aes(x=reorder(EVTYPE,-CropDmg),y=CropDmg,fill=CropDmg))+
                    geom_bar(stat="identity",position="dodge")+
                    xlab("Type Of Event")+ylab("Sum of Damages")+ggtitle("Top 10 Crop Damage")
      
      PlotAgg <-  ggplot(Top10_Agg,aes(x=reorder(EVTYPE,-Total),y=Total,fill=Total))+
                    geom_bar(stat="identity",position="dodge")+
                    xlab("Type Of Event")+ylab("Sum of Damages")+ggtitle("Top 10 Cumulative Damage")
      
```

# Results
In this sample, Tornados are the principal factors of Injuries and Fatalities whitin the US, followed by Excessive Heat.
```{r }
  plotQ1
```
Concerning the Damage, Flood is the main factor of Property Damage, wherease Drought is Crop main responsible.
If we're looking at the intersection between Crop and Property, Flood is still the main factor of US Damage from 50 to '11. Followed by Hurricane/Typhoon and Tornado.
```{r }
   grid.arrange(PlotProp,PlotCrop,PlotAgg,nrow=3)
```

